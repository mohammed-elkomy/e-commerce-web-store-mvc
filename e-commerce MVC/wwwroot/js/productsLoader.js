const exampleHtmlResponse = `
<div class="col-md-4 products-right-grids-bottom-grid">
    <div class="new-collections-grid1 products-right-grid1 animated wow slideInUp" data-wow-delay=".5s">
        <div class="new-collections-grid1-image">
            <a href="single.html" class="product-image"><img src="/images/19.jpg" alt=" " class="img-responsive"></a>
            <div class="new-collections-grid1-image-pos products-right-grids-pos">
                <a href="single.html">Quick View</a>
            </div>
            <div class="new-collections-grid1-right products-right-grids-pos-right">
                <div class="rating">
                    <div class="rating-left">
                        <img src="/images/2.png" alt=" " class="img-responsive">
                    </div>
                    <div class="rating-left">
                        <img src="/images/2.png" alt=" " class="img-responsive">
                    </div>
                    <div class="rating-left">
                        <img src="/images/2.png" alt=" " class="img-responsive">
                    </div>
                    <div class="rating-left">
                        <img src="/images/1.png" alt=" " class="img-responsive">
                    </div>
                    <div class="rating-left">
                        <img src="/images/1.png" alt=" " class="img-responsive">
                    </div>
                    <div class="clearfix"> </div>
                </div>
            </div>
        </div>
        <h4><a href="single.html">Formal Shirt</a></h4>
        <p>Vel illum qui dolorem.</p>
        <div class="simpleCart_shelfItem products-right-grid1-add-cart">
            <p><i>$325</i> <span class="item_price">$250</span><a class="item_add" href="#">add to cart </a></p>
        </div>
    </div>
    <div class="new-collections-grid1 products-right-grid1 animated wow slideInUp" data-wow-delay=".5s">
        <div class="new-collections-grid1-image">
            <a href="single.html" class="product-image"><img src="/images/21.jpg" alt=" " class="img-responsive"></a>
            <div class="new-collections-grid1-image-pos products-right-grids-pos">
                <a href="single.html">Quick View</a>
            </div>
            <div class="new-collections-grid1-right products-right-grids-pos-right">
                <div class="rating">
                    <div class="rating-left">
                        <img src="/images/2.png" alt=" " class="img-responsive">
                    </div>
                    <div class="rating-left">
                        <img src="/images/2.png" alt=" " class="img-responsive">
                    </div>
                    <div class="rating-left">
                        <img src="/images/2.png" alt=" " class="img-responsive">
                    </div>
                    <div class="rating-left">
                        <img src="/images/1.png" alt=" " class="img-responsive">
                    </div>
                    <div class="rating-left">
                        <img src="/images/1.png" alt=" " class="img-responsive">
                    </div>
                    <div class="clearfix"> </div>
                </div>
            </div>
        </div>
        <h4><a href="single.html">Casual Shoes</a></h4>
        <p>Vel illum qui dolorem.</p>
        <div class="simpleCart_shelfItem products-right-grid1-add-cart">
            <p><i>$325</i> <span class="item_price">$250</span><a class="item_add" href="#">add to cart </a></p>
        </div>
    </div>
    <div class="new-collections-grid1 products-right-grid1 animated wow slideInUp" data-wow-delay=".5s">
        <div class="new-collections-grid1-image">
            <a href="single.html" class="product-image"><img src="/images/24.jpg" alt=" " class="img-responsive"></a>
            <div class="new-collections-grid1-image-pos products-right-grids-pos">
                <a href="single.html">Quick View</a>
            </div>
            <div class="new-collections-grid1-right products-right-grids-pos-right">
                <div class="rating">
                    <div class="rating-left">
                        <img src="/images/2.png" alt=" " class="img-responsive">
                    </div>
                    <div class="rating-left">
                        <img src="/images/2.png" alt=" " class="img-responsive">
                    </div>
                    <div class="rating-left">
                        <img src="/images/2.png" alt=" " class="img-responsive">
                    </div>
                    <div class="rating-left">
                        <img src="/images/1.png" alt=" " class="img-responsive">
                    </div>
                    <div class="rating-left">
                        <img src="/images/1.png" alt=" " class="img-responsive">
                    </div>
                    <div class="clearfix"> </div>
                </div>
            </div>
        </div>
        <h4><a href="single.html">Blazer</a></h4>
        <p>Vel illum qui dolorem.</p>
        <div class="simpleCart_shelfItem products-right-grid1-add-cart">
            <p><i>$585</i> <span class="item_price">$489</span><a class="item_add" href="#">add to cart </a></p>
        </div>
    </div>
</div>
<div class="col-md-4 products-right-grids-bottom-grid">
    <div class="new-collections-grid1 products-right-grid1 animated wow slideInUp" data-wow-delay=".5s">
        <div class="new-collections-grid1-image">
            <a href="single.html" class="product-image"><img src="/images/7.jpg" alt=" " class="img-responsive"></a>
            <div class="new-collections-grid1-image-pos products-right-grids-pos">
                <a href="single.html">Quick View</a>
            </div>
            <div class="new-collections-grid1-right products-right-grids-pos-right">
                <div class="rating">
                    <div class="rating-left">
                        <img src="/images/2.png" alt=" " class="img-responsive">
                    </div>
                    <div class="rating-left">
                        <img src="/images/2.png" alt=" " class="img-responsive">
                    </div>
                    <div class="rating-left">
                        <img src="/images/2.png" alt=" " class="img-responsive">
                    </div>
                    <div class="rating-left">
                        <img src="/images/1.png" alt=" " class="img-responsive">
                    </div>
                    <div class="rating-left">
                        <img src="/images/1.png" alt=" " class="img-responsive">
                    </div>
                    <div class="clearfix"> </div>
                </div>
            </div>
        </div>
        <h4><a href="single.html">Formal Shirt</a></h4>
        <p>Vel illum qui dolorem.</p>
        <div class="simpleCart_shelfItem products-right-grid1-add-cart">
            <p><i>$280</i> <span class="item_price">$250</span><a class="item_add" href="#">add to cart </a></p>
        </div>
    </div>
    <div class="new-collections-grid1 products-right-grid1 animated wow slideInUp" data-wow-delay=".5s">
        <div class="new-collections-grid1-image">
            <a href="single.html" class="product-image"><img src="/images/22.jpg" alt=" " class="img-responsive"></a>
            <div class="new-collections-grid1-image-pos products-right-grids-pos">
                <a href="single.html">Quick View</a>
            </div>
            <div class="new-collections-grid1-right products-right-grids-pos-right">
                <div class="rating">
                    <div class="rating-left">
                        <img src="/images/2.png" alt=" " class="img-responsive">
                    </div>
                    <div class="rating-left">
                        <img src="/images/2.png" alt=" " class="img-responsive">
                    </div>
                    <div class="rating-left">
                        <img src="/images/2.png" alt=" " class="img-responsive">
                    </div>
                    <div class="rating-left">
                        <img src="/images/1.png" alt=" " class="img-responsive">
                    </div>
                    <div class="rating-left">
                        <img src="/images/1.png" alt=" " class="img-responsive">
                    </div>
                    <div class="clearfix"> </div>
                </div>
            </div>
        </div>
        <h4><a href="single.html">Casual Shoes</a></h4>
        <p>Vel illum qui dolorem.</p>
        <div class="simpleCart_shelfItem products-right-grid1-add-cart">
            <p><i>$500</i> <span class="item_price">$480</span><a class="item_add" href="#">add to cart </a></p>
        </div>
    </div>
    <div class="new-collections-grid1 products-right-grid1 animated wow slideInUp" data-wow-delay=".5s">
        <div class="new-collections-grid1-image">
            <a href="single.html" class="product-image"><img src="/images/25.jpg" alt=" " class="img-responsive"></a>
            <div class="new-collections-grid1-image-pos products-right-grids-pos">
                <a href="single.html">Quick View</a>
            </div>
            <div class="new-collections-grid1-right products-right-grids-pos-right">
                <div class="rating">
                    <div class="rating-left">
                        <img src="/images/2.png" alt=" " class="img-responsive">
                    </div>
                    <div class="rating-left">
                        <img src="/images/2.png" alt=" " class="img-responsive">
                    </div>
                    <div class="rating-left">
                        <img src="/images/2.png" alt=" " class="img-responsive">
                    </div>
                    <div class="rating-left">
                        <img src="/images/1.png" alt=" " class="img-responsive">
                    </div>
                    <div class="rating-left">
                        <img src="/images/1.png" alt=" " class="img-responsive">
                    </div>
                    <div class="clearfix"> </div>
                </div>
            </div>
        </div>
        <h4><a href="single.html">Blazer</a></h4>
        <p>Vel illum qui dolorem.</p>
        <div class="simpleCart_shelfItem products-right-grid1-add-cart">
            <p><i>$585</i> <span class="item_price">$489</span><a class="item_add" href="#">add to cart </a></p>
        </div>
    </div>
</div>
<div class="col-md-4 products-right-grids-bottom-grid">
    <div class="new-collections-grid1 products-right-grid1 animated wow slideInUp" data-wow-delay=".5s">
        <div class="new-collections-grid1-image">
            <a href="single.html" class="product-image"><img src="/images/20.jpg" alt=" " class="img-responsive"></a>
            <div class="new-collections-grid1-image-pos products-right-grids-pos">
                <a href="single.html">Quick View</a>
            </div>
            <div class="new-collections-grid1-right products-right-grids-pos-right">
                <div class="rating">
                    <div class="rating-left">
                        <img src="/images/2.png" alt=" " class="img-responsive">
                    </div>
                    <div class="rating-left">
                        <img src="/images/2.png" alt=" " class="img-responsive">
                    </div>
                    <div class="rating-left">
                        <img src="/images/2.png" alt=" " class="img-responsive">
                    </div>
                    <div class="rating-left">
                        <img src="/images/1.png" alt=" " class="img-responsive">
                    </div>
                    <div class="rating-left">
                        <img src="/images/1.png" alt=" " class="img-responsive">
                    </div>
                    <div class="clearfix"> </div>
                </div>
            </div>
        </div>
        <h4><a href="single.html">Formal Shirt</a></h4>
        <p>Vel illum qui dolorem.</p>
        <div class="simpleCart_shelfItem products-right-grid1-add-cart">
            <p><i>$305</i> <span class="item_price">$280</span><a class="item_add" href="#">add to cart </a></p>
        </div>
    </div>
    <div class="new-collections-grid1 products-right-grid1 animated wow slideInUp" data-wow-delay=".5s">
        <div class="new-collections-grid1-image">
            <a href="single.html" class="product-image"><img src="/images/23.jpg" alt=" " class="img-responsive"></a>
            <div class="new-collections-grid1-image-pos products-right-grids-pos">
                <a href="single.html">Quick View</a>
            </div>
            <div class="new-collections-grid1-right products-right-grids-pos-right">
                <div class="rating">
                    <div class="rating-left">
                        <img src="/images/2.png" alt=" " class="img-responsive">
                    </div>
                    <div class="rating-left">
                        <img src="/images/2.png" alt=" " class="img-responsive">
                    </div>
                    <div class="rating-left">
                        <img src="/images/2.png" alt=" " class="img-responsive">
                    </div>
                    <div class="rating-left">
                        <img src="/images/1.png" alt=" " class="img-responsive">
                    </div>
                    <div class="rating-left">
                        <img src="/images/1.png" alt=" " class="img-responsive">
                    </div>
                    <div class="clearfix"> </div>
                </div>
            </div>
        </div>
        <h4><a href="single.html">Casual Shoes</a></h4>
        <p>Vel illum qui dolorem.</p>
        <div class="simpleCart_shelfItem products-right-grid1-add-cart">
            <p><i>$389</i> <span class="item_price">$299</span><a class="item_add" href="#">add to cart </a></p>
        </div>
    </div>
    <div class="new-collections-grid1 products-right-grid1 animated wow slideInUp" data-wow-delay=".5s">
        <div class="new-collections-grid1-image">
            <a href="single.html" class="product-image"><img src="/images/26.jpg" alt=" " class="img-responsive"></a>
            <div class="new-collections-grid1-image-pos products-right-grids-pos">
                <a href="single.html">Quick View</a>
            </div>
            <div class="new-collections-grid1-right products-right-grids-pos-right">
                <div class="rating">
                    <div class="rating-left">
                        <img src="/images/2.png" alt=" " class="img-responsive">
                    </div>
                    <div class="rating-left">
                        <img src="/images/2.png" alt=" " class="img-responsive">
                    </div>
                    <div class="rating-left">
                        <img src="/images/2.png" alt=" " class="img-responsive">
                    </div>
                    <div class="rating-left">
                        <img src="/images/1.png" alt=" " class="img-responsive">
                    </div>
                    <div class="rating-left">
                        <img src="/images/1.png" alt=" " class="img-responsive">
                    </div>
                    <div class="clearfix"> </div>
                </div>
            </div>
        </div>
        <h4><a href="single.html">Blazer</a></h4>
        <p>Vel illum qui dolorem.</p>
        <div class="simpleCart_shelfItem products-right-grid1-add-cart">
            <p><i>$585</i> <span class="item_price">$489</span><a class="item_add" href="#">add to cart </a></p>
        </div>
    </div>
</div>
<div class="clearfix"> </div>`

const exampleCategoryTree = [{
    name: 'Best Selling',
    count: 15,
    value: 0
}, {
    name: 'By type',
    children: [{
        name: 'Seating',
        count: 15,
        value: 1,
        children: [{
                name: 'Single seat',
                count: 10,
                value: 2,
                children: [{
                        name: 'Chair',
                        count: 4,
                        value: 3
                    },
                    { name: 'Bean bag', count: 4, value: 4 },
                    { name: 'Stool', count: 2, value: 5 }
                ]
            },
            { name: 'Multiple seats', count: 5, value: 6 }
        ]
    }, {
        name: 'Sleeping or lying',
        count: 25,
        value: 7,
        children: [
            { name: 'Bed', count: 20, value: 8 },
            { name: 'Sofa bed', count: 5, value: 9 }
        ]
    }]
}, {
    name: 'By material',
    children: [
        { name: 'Beech', count: 5, value: 10 },
        { name: 'Ash', count: 5, value: 11 },
        { name: 'Oak', count: 6, value: 12 }
    ]
}]
$(function() {
    var searchConfig = {}
    var pagination = $('#pagination');
    const defaultPaginationOptions = {
        totalPages: searchConfig.page,
        visiblePages: 7,
        startPage: searchConfig.page,
        initiateStartPageClick: false,
        onPageClick: function(event, page) {
            searchConfig.page = page;
            goToHash();
        }
    }

    function drawCategoryTree(arr) {
        function getListItem(obj) {
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.text = obj.name
            if (typeof(obj.value) === 'number')
                a.addEventListener('click', function() {
                    searchConfig.category = obj.value;
                    console.log(obj.value);
                    goToHash();
                })
            li.appendChild(a);
            if (obj.count) {
                const span = document.createElement('span');
                span.innerText = '(' + obj.count + ')';
                li.appendChild(span);
            }
            if (obj.children && obj.children.length) {
                const ul = document.createElement('ul');
                for (const child of obj.children) {
                    ul.appendChild(getListItem(child));
                }
                li.appendChild(ul);
            }
            return li;
        }
        const ul = document.createElement('ul');
        for (const category of arr) {
            ul.appendChild(getListItem(category));
        }
        ul.classList.add('cate');
        $('#categories').empty();
        $('#categories').append(ul);
    }

    function goToHash() {
        location.hash = $.param(searchConfig);
    }

    // required hash params: globalMinPrice, globalMaxPrice, minPrice, maxPrice
    function loadParams() {
        const hashArray = window.location.hash.substr(1).split('&');
        for (const param of hashArray) {
            const kvp = param.split('=');
            if (kvp[1])
                searchConfig[kvp[0]] = kvp[1];
        }
        searchConfig.globalMinPrice = parseInt(searchConfig.globalMinPrice) || 0;
        searchConfig.globalMaxPrice = parseInt(searchConfig.globalMaxPrice) || 1000000;
        searchConfig.minPrice = parseInt(searchConfig.minPrice) || 0;
        searchConfig.maxPrice = parseInt(searchConfig.maxPrice) || 200000
        searchConfig.orderBy = searchConfig.orderBy || 0;
        searchConfig.perPage = parseInt(searchConfig.perPage) || 9;
        searchConfig.page = parseInt(searchConfig.page) || 1;
        searchConfig.category = parseInt(searchConfig.category) || 0;
        console.log(searchConfig);
    }

    function loadProducts() {
        loadParams();
        const params = $.param(searchConfig);
        var totalPages = 10;
        // send ajax request and get response:
        // 1- contains html content (partial view) to place inside collection.
        // 2- contains total pages with respsect to current perPage setting.
        // 3- contains full category tree (nested object), along with count per category
        $('#searchContent').empty();
        $('#searchContent').html(exampleHtmlResponse);
        pagination.twbsPagination('destroy');
        pagination.twbsPagination($.extend({}, defaultPaginationOptions, {
            startPage: searchConfig.page,
            totalPages: totalPages
        }));
        drawCategoryTree(exampleCategoryTree);
    }

    // note: events on ui elements: location.hash = location.hash.replace('minPrice=10','minPrice=100')

    loadParams();


    $("#slider-range").slider({
        range: true,
        min: searchConfig.globalMinPrice,
        max: searchConfig.globalMaxPrice,
        values: [searchConfig.minPrice, searchConfig.maxPrice],
        step: 200,
        slide: function(event, ui) {
            $("#amount").val("$" + ui.values[0] + " - $" + ui.values[1]);
        },
        stop: function(event, ui) {
            searchConfig.minPrice = ui.values[0];
            searchConfig.maxPrice = ui.values[1];
            goToHash();
        }
    });
    $("#amount").val("$" + $("#slider-range").slider("values", 0) + " - $" + $("#slider-range").slider("values", 1));

    $('#orderBy').val(searchConfig.orderBy)
    $('#orderBy').on('change', function(event) {
        searchConfig.orderBy = event.currentTarget.value
        goToHash();
    });

    $('#perPage').val(searchConfig.orderBy)
    $('#perPage').on('change', function(event) {
        searchConfig.perPage = event.currentTarget.value
        goToHash();
    });

    pagination.twbsPagination(defaultPaginationOptions);

    window.addEventListener('hashchange', function() { alert('changed hash, reloading...'); });
    window.addEventListener('hashchange', loadProducts);
    loadProducts();

})